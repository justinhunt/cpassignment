define(["jquery","jqueryui","core/log","mod_cpassignment/recorderhelper","mod_cpassignment/dialogs","core/templates","core/ajax","core/notification"],(function($,jqui,log,recorderhelper,dialogs,templates,Ajax,notification){return log.debug("Activity controller: initialising"),{cmid:null,activitydata:null,recorderid:null,successmessageid:null,sorryboxid:null,controls:null,moduleclass:null,selectedattempt:0,graded:!1,clone:function(){return $.extend(!0,{},this)},init:function(props){var dd=this.clone(),theid="#amdopts_"+props.widgetid,configcontrol=$(theid).get(0);configcontrol?(dd.activitydata=JSON.parse(configcontrol.value),$(theid).remove(),dd.moduleclass=dd.activitydata.moduleclass,dd.cmid=props.cmid,dd.recorderid=dd.activitydata.recorderid,dd.sorryboxid="sorryboxid-would-go-here",dd.successmessageid=dd.moduleclass+"_uploadsuccess",dd.startbuttonid=dd.moduleclass+"_startbutton",dd.selectedattempt=dd.activitydata.selectedattempt,dd.graded=dd.activitydata.graded,dd.is_browser_ok()?(dd.setup_recorder(),dd.process_html(dd.activitydata),dd.register_events()):$("#"+dd.sorryboxid).show()):log.debug("Read Aloud Test Controller: No config found on page. Giving up.")},process_html:function(opts){var controls={finishedcontainer:$("."+opts.finishedcontainer),errorcontainer:$("."+opts.errorcontainer),recordingcontainer:$("."+opts.recordingcontainer),recordercontainer:$("."+opts.recordercontainer),instructionscontainer:$("."+opts.instructionscontainer),startbuttoncontainer:$("."+opts.moduleclass+"_startbuttoncontainer"),myattemptscontainer:$("."+opts.moduleclass+"_myattempts_cont"),myattemptslabel:$("."+opts.moduleclass+"_myattempts_caption"),currentfeedbackcontainer:$("."+opts.moduleclass+"_current_feedback_cont"),attemptstatuscontainer:$("."+opts.moduleclass+"_attempt_status_cont"),startbutton:$("#"+opts.moduleclass+"_startbutton"),selectattemptbutton:$("."+opts.moduleclass+"_selectattempt")};if(this.controls=controls,this.graded||this.update_attempt_table(this,this.selectedattempt),"summary"===opts.pagemode)this.dosummarylayout()},beginall:function(){this.passagerecorded=!0},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function(){var dd=this;recorderhelper.init(dd.activitydata,(function(eventdata){}),(function(eventdata){}),(function(eventdata){dd.send_submission(eventdata.mediaurl),dd.dofinishedlayout()}))},register_events:function(){var dd=this;dd.controls.startbutton.click((function(){dd.dorecordinglayout()})),dd.controls.selectattemptbutton.click((function(){dd.select_attempt($(this).attr("data-attemptid"))}))},select_attempt:function(attemptid){Ajax.call([{methodname:"mod_cpassignment_select_attempt",args:{cmid:that.cmid,attemptid:attemptid},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success)that.update_attempt_table(that,attemptid),that.selectedattempt=attemptid,dialogs.openModal("#"+that.successmessageid);else payloadobject.message&&log.debug("message: "+payloadobject.message)},fail:notification.exception}])},update_attempt_table:function(that,selectedattemptid){var submitlabel=M.util.get_string("submitted","mod_cpassignment");$(".mod_cpassignment_cell_attempts_status").text("");var therow=$("."+this.moduleclass+"_attemptrow[data-attemptid="+selectedattemptid+"]");therow.find(".mod_cpassignment_cell_attempts_status").text(submitlabel),therow.trigger("click")},insert_new_attempt:function(that,record){templates.render("mod_cpassignment/attemptrow",record).then((function(html,js){that.selectedattempt=record.id,that.controls.myattemptscontainer.find("tbody").append(html),that.update_attempt_table(that,record.id)}))},send_submission:function(filename){var that=this;Ajax.call([{methodname:"mod_cpassignment_submit_attempt",args:{filename:filename,cmid:that.cmid},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success){var record={};record.id=payloadobject.newattempt.id,record.mediafile=filename,record.timecreated=payloadobject.newattempt.timecreated,record.status="",record.grade_p=0,that.insert_new_attempt(that,record),dialogs.openModal("#"+that.successmessageid)}else payloadobject.message&&log.debug("message: "+payloadobject.message)},fail:notification.exception}])},dorecordinglayout:function(){var m=this;m.controls.instructionscontainer.show(),m.controls.startbuttoncontainer.hide(),m.controls.myattemptscontainer.hide(),m.controls.myattemptslabel.hide(),m.controls.attemptstatuscontainer.hide(),m.controls.currentfeedbackcontainer.hide(),m.controls.recordingcontainer.show()},dosummarylayout:function(){var m=this;m.controls.instructionscontainer.show(),m.controls.recordingcontainer.hide(),m.controls.finishedcontainer.hide(),m.controls.startbuttoncontainer.show(),m.controls.myattemptscontainer.show(),m.controls.myattemptslabel.show(),m.controls.attemptstatuscontainer.show(),m.controls.currentfeedbackcontainer.show()},dofinishedlayout:function(){var m=this;m.controls.instructionscontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.finishedcontainer.show(),m.controls.startbuttoncontainer.hide(),m.controls.myattemptscontainer.show(),m.controls.myattemptslabel.show(),m.controls.attemptstatuscontainer.show(),m.controls.currentfeedbackcontainer.hide()},doerrorlayout:function(){var m=this;m.controls.recordingcontainer.hide(),m.controls.errorcontainer.show(),m.controls.startbuttoncontainer.hide(),m.controls.myattemptscontainer.hide(),m.controls.myattemptslabel.hide(),m.controls.attemptstatuscontainer.hide(),m.controls.currentfeedbackcontainer.hide()}}}));

//# sourceMappingURL=activitycontroller.min.js.map