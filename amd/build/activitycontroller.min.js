define ("mod_cpassignment/activitycontroller",["jquery","jqueryui","core/log","mod_cpassignment/recorderhelper","mod_cpassignment/dialogs","core/templates","core/ajax","core/notification"],function(a,b,c,d,e,f,g,h){"use strict";c.debug("Activity controller: initialising");return{cmid:null,activitydata:null,recorderid:null,successmessageid:null,sorryboxid:null,controls:null,moduleclass:null,selectedattempt:0,graded:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(b){var d=this.clone(),e="#amdopts_"+b.widgetid,f=a(e).get(0);if(f){d.activitydata=JSON.parse(f.value);a(e).remove()}else{c.debug("Read Aloud Test Controller: No config found on page. Giving up.");return}d.moduleclass=d.activitydata.moduleclass;d.cmid=b.cmid;d.recorderid=d.activitydata.recorderid;d.sorryboxid="sorryboxid-would-go-here";d.successmessageid=d.moduleclass+"_uploadsuccess";d.startbuttonid=d.moduleclass+"_startbutton";d.selectedattempt=d.activitydata.selectedattempt;d.graded=d.activitydata.graded;if(!d.is_browser_ok()){a("#"+d.sorryboxid).show();return}d.setup_recorder();d.process_html(d.activitydata);d.register_events()},process_html:function process_html(b){var c={finishedcontainer:a("."+b.finishedcontainer),errorcontainer:a("."+b.errorcontainer),recordingcontainer:a("."+b.recordingcontainer),recordercontainer:a("."+b.recordercontainer),instructionscontainer:a("."+b.instructionscontainer),startbuttoncontainer:a("."+b.moduleclass+"_startbuttoncontainer"),myattemptscontainer:a("."+b.moduleclass+"_myattempts_cont"),myattemptslabel:a("."+b.moduleclass+"_myattempts_caption"),currentfeedbackcontainer:a("."+b.moduleclass+"_current_feedback_cont"),attemptstatuscontainer:a("."+b.moduleclass+"_attempt_status_cont"),startbutton:a("#"+b.moduleclass+"_startbutton"),selectattemptbutton:a("."+b.moduleclass+"_selectattempt")};this.controls=c;if(!this.graded){this.update_attempt_table(this,this.selectedattempt)}switch(b.pagemode){case"summary":this.dosummarylayout();break;case"attempt":default:}},beginall:function beginall(){var a=this;a.passagerecorded=!0},is_browser_ok:function is_browser_ok(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function setup_recorder(){var a=this;d.init(a.activitydata,function on_recording_start(){},function on_recording_end(){},function on_audio_processing(b){a.send_submission(b.mediaurl);a.dofinishedlayout()})},register_events:function register_events(){var b=this;b.controls.startbutton.click(function(){b.dorecordinglayout()});b.controls.selectattemptbutton.click(function(){b.select_attempt(a(this).attr("data-attemptid"))})},select_attempt:function select_attempt(a){g.call([{methodname:"mod_cpassignment_select_attempt",args:{cmid:that.cmid,attemptid:a},done:function done(b){var d=JSON.parse(b);if(d){switch(d.success){case!0:that.update_attempt_table(that,a);that.selectedattempt=a;e.openModal("#"+that.successmessageid);break;case!1:default:if(d.message){c.debug("message: "+d.message)}}}},fail:h.exception}])},update_attempt_table:function update_attempt_table(b,c){var d=M.util.get_string("submitted","mod_cpassignment");a(".mod_cpassignment_cell_attempts_status").text("");var e=a("."+this.moduleclass+"_attemptrow[data-attemptid="+c+"]");e.find(".mod_cpassignment_cell_attempts_status").text(d);e.trigger("click")},insert_new_attempt:function insert_new_attempt(a,b){f.render("mod_cpassignment/attemptrow",b).then(function(c){a.selectedattempt=b.id;a.controls.myattemptscontainer.find("tbody").append(c);a.update_attempt_table(a,b.id)})},send_submission:function send_submission(a){var b=this;g.call([{methodname:"mod_cpassignment_submit_attempt",args:{filename:a,cmid:b.cmid},done:function done(d){var f=JSON.parse(d);if(f){switch(f.success){case!0:var g={};g.id=f.newattempt.id;g.mediafile=a;g.timecreated=f.newattempt.timecreated;g.status="";g.grade_p=0;b.insert_new_attempt(b,g);e.openModal("#"+b.successmessageid);break;case!1:default:if(f.message){c.debug("message: "+f.message)}}}},fail:h.exception}])},dorecordinglayout:function dorecordinglayout(){var a=this;a.controls.instructionscontainer.show();a.controls.startbuttoncontainer.hide();a.controls.myattemptscontainer.hide();a.controls.myattemptslabel.hide();a.controls.attemptstatuscontainer.hide();a.controls.currentfeedbackcontainer.hide();a.controls.recordingcontainer.show()},dosummarylayout:function dosummarylayout(){var a=this;a.controls.instructionscontainer.show();a.controls.recordingcontainer.hide();a.controls.finishedcontainer.hide();a.controls.startbuttoncontainer.show();a.controls.myattemptscontainer.show();a.controls.myattemptslabel.show();a.controls.attemptstatuscontainer.show();a.controls.currentfeedbackcontainer.show()},dofinishedlayout:function dofinishedlayout(){var a=this;a.controls.instructionscontainer.hide();a.controls.recordingcontainer.hide();a.controls.finishedcontainer.show();a.controls.startbuttoncontainer.hide();a.controls.myattemptscontainer.show();a.controls.myattemptslabel.show();a.controls.attemptstatuscontainer.show();a.controls.currentfeedbackcontainer.hide()},doerrorlayout:function doerrorlayout(){var a=this;a.controls.recordingcontainer.hide();a.controls.errorcontainer.show();a.controls.startbuttoncontainer.hide();a.controls.myattemptscontainer.hide();a.controls.myattemptslabel.hide();a.controls.attemptstatuscontainer.hide();a.controls.currentfeedbackcontainer.hide()}}});
//# sourceMappingURL=activitycontroller.min.js.map
