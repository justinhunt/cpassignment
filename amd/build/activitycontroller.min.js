define(["jquery","jqueryui","core/log","mod_cpassignment/recorderhelper","mod_cpassignment/dialogs","core/templates"],function(a,b,c,d,e,f){"use strict";return c.debug("Activity controller: initialising"),{cmid:null,activitydata:null,recorderid:null,successmessageid:null,sorryboxid:null,controls:null,moduleclass:null,selectedattempt:0,graded:!1,clone:function(){return a.extend(!0,{},this)},init:function(b){var d=this.clone(),e="#amdopts_"+b.widgetid,f=a(e).get(0);return f?(d.activitydata=JSON.parse(f.value),a(e).remove(),d.moduleclass=d.activitydata.moduleclass,d.cmid=b.cmid,d.recorderid=d.activitydata.recorderid,d.sorryboxid="sorryboxid-would-go-here",d.successmessageid=d.moduleclass+"_uploadsuccess",d.startbuttonid=d.moduleclass+"_startbutton",d.selectedattempt=d.activitydata.selectedattempt,d.graded=d.activitydata.graded,d.is_browser_ok()?(d.setup_recorder(),d.process_html(d.activitydata),void d.register_events()):void a("#"+d.sorryboxid).show()):void c.debug("Read Aloud Test Controller: No config found on page. Giving up.")},process_html:function(b){var c={finishedcontainer:a("."+b.finishedcontainer),errorcontainer:a("."+b.errorcontainer),recordingcontainer:a("."+b.recordingcontainer),recordercontainer:a("."+b.recordercontainer),instructionscontainer:a("."+b.instructionscontainer),startbuttoncontainer:a("."+b.moduleclass+"_startbuttoncontainer"),myattemptscontainer:a("."+b.moduleclass+"_myattempts_cont"),myattemptslabel:a("."+b.moduleclass+"_myattempts_caption"),currentfeedbackcontainer:a("."+b.moduleclass+"_current_feedback_cont"),attemptstatuscontainer:a("."+b.moduleclass+"_attempt_status_cont"),startbutton:a("#"+b.moduleclass+"_startbutton"),selectattemptbutton:a("."+b.moduleclass+"_selectattempt")};switch(this.controls=c,this.graded||this.update_attempt_table(this,this.selectedattempt),b.pagemode){case"summary":this.dosummarylayout();break;case"attempt":}},beginall:function(){var a=this;a.passagerecorded=!0},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function(){var a=this,b=function(a){},c=function(a){},e=function(b){a.send_submission(b.mediaurl),a.dofinishedlayout()};d.init(a.activitydata,b,c,e)},register_events:function(){var b=this;b.controls.startbutton.click(function(){b.dorecordinglayout()}),b.controls.selectattemptbutton.click(function(){b.select_attempt(a(this).attr("data-attemptid"))})},select_attempt:function(a){var b=new XMLHttpRequest,d=this;b.onreadystatechange=function(f){if(4===this.readyState)if(200==b.status){var g=b.responseText,h=JSON.parse(g);if(h)switch(h.success){case!0:d.update_attempt_table(d,a),d.selectedattempt=a,e.openModal("#"+d.successmessageid);break;case!1:default:h.message&&c.debug("message: "+h.message)}}else c.debug("Not 200 response:"+b.status)};var f="action=selectattempt&cmid="+d.cmid+"&attemptid="+a;b.open("POST",M.cfg.wwwroot+"/mod/cpassignment/ajaxhelper.php",!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),b.setRequestHeader("Cache-Control","no-cache"),b.send(f)},update_attempt_table:function(b,c){var d=M.util.get_string("submitted","mod_cpassignment");a(".mod_cpassignment_cell_attempts_status").text("");var e=a("."+this.moduleclass+"_attemptrow[data-attemptid="+c+"]");e.find(".mod_cpassignment_cell_attempts_status").text(d),e.trigger("click")},insert_new_attempt:function(a,b){f.render("mod_cpassignment/attemptrow",b).then(function(c,d){a.selectedattempt=b.id,a.controls.myattemptscontainer.find("tbody").append(c),a.update_attempt_table(a,b.id)})},send_submission:function(a){var b=new XMLHttpRequest,d=this;b.onreadystatechange=function(f){if(4===this.readyState)if(200==b.status){var g=b.responseText,h=JSON.parse(g);if(h)switch(h.success){case!0:var i={};i.id=h.newattempt.id,i.mediafile=a,i.timecreated=h.newattempt.timecreated,i.status="",i.grade_p=0,d.insert_new_attempt(d,i),e.openModal("#"+d.successmessageid);break;case!1:default:h.message&&c.debug("message: "+h.message)}}else c.debug("Not 200 response:"+b.status)};var f="action=sendsubmission&cmid="+d.cmid+"&filename="+a;b.open("POST",M.cfg.wwwroot+"/mod/cpassignment/ajaxhelper.php",!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),b.setRequestHeader("Cache-Control","no-cache"),b.send(f)},dorecordinglayout:function(){var a=this;a.controls.instructionscontainer.show(),a.controls.startbuttoncontainer.hide(),a.controls.myattemptscontainer.hide(),a.controls.myattemptslabel.hide(),a.controls.attemptstatuscontainer.hide(),a.controls.currentfeedbackcontainer.hide(),a.controls.recordingcontainer.show()},dosummarylayout:function(){var a=this;a.controls.instructionscontainer.show(),a.controls.recordingcontainer.hide(),a.controls.finishedcontainer.hide(),a.controls.startbuttoncontainer.show(),a.controls.myattemptscontainer.show(),a.controls.myattemptslabel.show(),a.controls.attemptstatuscontainer.show(),a.controls.currentfeedbackcontainer.show()},dofinishedlayout:function(){var a=this;a.controls.instructionscontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.finishedcontainer.show(),a.controls.startbuttoncontainer.hide(),a.controls.myattemptscontainer.show(),a.controls.myattemptslabel.show(),a.controls.attemptstatuscontainer.show(),a.controls.currentfeedbackcontainer.hide()},doerrorlayout:function(){var a=this;a.controls.recordingcontainer.hide(),a.controls.errorcontainer.show(),a.controls.startbuttoncontainer.hide(),a.controls.myattemptscontainer.hide(),a.controls.myattemptslabel.hide(),a.controls.attemptstatuscontainer.hide(),a.controls.currentfeedbackcontainer.hide()}}});