define(["jquery","core/config","core/log","core/ajax","core/templates","core/modal_factory","core/str","core/modal_events","mod_cpassignment/cloudpoodllloader","mod_cpassignment/dialogs","mod_cpassignment/datatables","core/notification"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";return c.debug("cpassignment list helper: initialising"),{controls:{},modulecssclass:null,cmid:null,moduleid:0,strings:[],authmode:"normal",accesskey:"",init:function(a){this.modulecssclass=a.modulecssclass,this.moduleid=a.moduleid,this.cmid=a.cmid,a.hasOwnProperty("authmode")&&(this.authmode=a.authmode),a.hasOwnProperty("accesskey")&&(this.accesskey=a.accesskey),this.prepare_html(),this.register_events(),this.init_recorder(this.audiorecid)},init_strings:function(){for(var a=this,b=["deletedialogtitle","deletedialogquestion","deletelabel"],c=0;c<b.length;c++)g.get_string(b[c],"mod_cpassignment").then(function(b){a.strings[c]=b})},prepare_html:function(){this.controls.arecstartbutton=a("#"+this.modulecssclass+"_listaudiorecstart"),this.controls.shareboxbutton=a("#"+this.modulecssclass+"_listshareboxstart"),this.controls.shareboxresetkeybutton=a("#"+this.modulecssclass+"_sharebox_resetkey_button"),this.controls.sharebox=a("#"+this.modulecssclass+"_sharebox"),this.controls.shareboxcopybutton=a("#"+this.modulecssclass+"_sharebox_copy_button"),this.controls.receiptscontainer=a("#"+this.modulecssclass+"_receipts_container"),this.controls.noitemscontainer=a("#"+this.modulecssclass+"_noitems_cont"),this.controls.itemscontainer=a("#"+this.modulecssclass+"_items_cont"),this.controls.areccontainer=a("#"+this.modulecssclass+"_arec_container"),this.controls.rectable=a("#"+this.modulecssclass+"_itemstable__opts_9999"),this.controls.itemnamefield=a(".itemform_itemname"),this.controls.itemidfield=a(".itemform_itemid"),this.controls.itemfilenamefield=a(".itemform_itemfilename"),this.controls.itemsubidfield=a(".itemform_itemsubid"),this.controls.dialogdownloadlink=a("#"+this.modulecssclass+"_download_link"),this.controls.dialogdownloadbutton=a("#"+this.modulecssclass+"_download_button"),this.controls.dialogdownloadname=a("#"+this.modulecssclass+"_download_name"),this.controls.downloadlinkcopybutton=a("#"+this.modulecssclass+"_download_copy_button"),this.audiorecid="therecorderid_mod_cpassignment_listaudiorec",this.controls.deletebutton=a("#"+this.modulecssclass+'_itemstable__opts_9999 a[data-type="delete"]'),this.controls.downloadbutton=a("#"+this.modulecssclass+'_itemstable__opts_9999 a[data-type="download"]'),this.controls.arecstartbutton.show(),this.controls.shareboxbutton.show(),this.controls.thedatatable=k.getDataTable(this.modulecssclass+"_itemstable__opts_9999")},register_events:function(){var b=this;this.controls.arecstartbutton.click(function(){b.controls.itemfilenamefield.val(""),b.controls.itemidfield.val(""),b.controls.itemnamefield.val(""),b.controls.itemsubidfield.val("0"),j.openModal("#"+b.modulecssclass+"_arec_container")}),this.controls.shareboxbutton.click(function(){b.show_sharebox()}),this.controls.shareboxresetkeybutton.click(function(){return f.create({type:f.types.SAVE_CANCEL,title:"Reset the Public Link",body:"Resetting the public link will change it and the previous link will no longer work anymore. Are you sure that you want to do this?"}).then(function(a){a.setSaveButtonText("RESET");var c=a.getRoot();c.on(h.save,function(){b.do_resetkey(b,b.moduleid)}),a.show()}),!1}),this.controls.shareboxcopybutton.click(function(){var a=b.controls.sharebox[0];a.select(),a.setSelectionRange(0,99999),document.execCommand("copy")}),this.controls.downloadlinkcopybutton.click(function(){var a=b.controls.dialogdownloadlink[0];a.select(),a.setSelectionRange(0,99999),document.execCommand("copy")}),this.controls.rectable.on("click",'a[data-type="download"]',function(c){var d=a(c.currentTarget),e=d.data("id");return b.show_download(b,e),!1}),this.controls.rectable.on("click",'a[data-type="delete"]',function(c){var d=a(c.currentTarget),e=d.data("id"),g=a('td.itemname span[data-itemid="'+e+'"]').data("value");return f.create({type:f.types.SAVE_CANCEL,title:"Delete Media",body:"Do you really want to delete audio? <i>"+g+"</i>"}).then(function(a){a.setSaveButtonText("DELETE");var c=a.getRoot();c.on(h.save,function(){b.controls.thedatatable.row(d.parents("tr")).remove().draw(),b.controls.thedatatable.count()||(b.controls.noitemscontainer.show(),b.controls.itemscontainer.hide()),b.do_delete(e)}),a.show()}),!1})},show_download:function(b,c){var d=a('td.itemname span[data-itemid="'+c+'"]').data("value"),e=a('td.item audio[data-id="'+c+'"]').attr("src");b.controls.dialogdownloadlink.val(e),b.controls.dialogdownloadbutton.attr("href",e),b.controls.dialogdownloadname.html("<h3>Download: "+d+"</h3>"),j.openModal("#"+b.modulecssclass+"_download_container")},show_sharebox:function(){var a=this;j.openModal("#"+a.modulecssclass+"_sharebox_container")},do_resetkey:function(a,e){d.call([{methodname:"mod_cpassignment_reset_key",args:{moduleid:e},done:function(d){var e=JSON.parse(d);if(e)switch(e.success){case!0:var f=e.message;a.controls.sharebox.val(b.wwwroot+"/mod/cpassignment/k.php?k="+f);break;case!1:default:e.message&&c.debug("message: "+e.message)}},fail:l.exception}])},do_delete:function(a){d.call([{methodname:"mod_cpassignment_remove_rec",args:{itemid:a},done:function(a){var b=JSON.parse(a);if(b)switch(b.success){case!0:break;case!1:default:b.message&&c.debug("message: "+b.message)}},fail:l.exception}])},init_recorder:function(a){var b=this;i.init(a,function(a){switch(console.log(a),a.type){case"recording":break;case"awaitingprocessing":"posted"!=b.status,b.status="posted";break;case"filesubmitted":b.controls.itemfilenamefield.val(a.mediaurl);var c=b.controls.itemfilenamefield.val(),d=b.controls.itemidfield.val(),e=b.controls.itemnamefield.val(),f=b.controls.itemsubidfield.val();b.send_submission(f,c,d,e)}})},re_init_recorder:function(b,c){var d=a("#"+c);d.empty(),d.attr("data-alreadyparsed","false");var e=!1;i.init(c,e)},insert_new_item:function(b,c){b.controls.noitemscontainer.hide(),b.controls.itemscontainer.show(),e.render("mod_cpassignment/itemrow",c).then(function(c,d){b.controls.thedatatable.row.add(a(c)[0]).draw()})},acknowledge_receipt:function(a,b){a.controls.receiptscontainer.show(),e.render("mod_cpassignment/onereceipt",b).then(function(b,c){a.controls.receiptscontainer.prepend(b)})},send_submission:function(a,b,e,f){var g=this,h={subid:a,filename:b,itemname:f,itemid:e,cmid:g.cmid};"guest"===this.authmode?h.accesskey=g.accesskey:h.accesskey="none",d.call([{methodname:"mod_cpassignment_submit_rec",args:h,done:function(a){var b=JSON.parse(a);if(b)switch(b.success){case!0:var d=b.item;"guest"===g.authmode?g.acknowledge_receipt(g,d):g.insert_new_item(g,d),j.closeModal("#"+g.modulecssclass+"_arec_container"),g.re_init_recorder(g,g.audiorecid);break;case!1:default:b.message&&c.debug("message: "+b.message),j.closeModal("#"+g.modulecssclass+"_arec_container"),g.clear_recorder(),g.re_init_recorder(g.audiorecid)}},fail:l.exception}])}}});