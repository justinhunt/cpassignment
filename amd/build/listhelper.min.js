define(["jquery","core/config","core/log","core/ajax","core/templates","core/modal_factory","core/str","core/modal_events","mod_cpassignment/cloudpoodllloader","mod_cpassignment/dialogs","mod_cpassignment/datatables","core/notification"],(function($,cfg,log,Ajax,templates,ModalFactory,str,ModalEvents,cloudpoodll,dialogs,datatables,notification){return log.debug("cpassignment list helper: initialising"),{controls:{},modulecssclass:null,cmid:null,moduleid:0,strings:[],authmode:"normal",accesskey:"",max:0,init:function(props){this.modulecssclass=props.modulecssclass,this.moduleid=props.moduleid,this.cmid=props.cmid,props.hasOwnProperty("authmode")&&(this.authmode=props.authmode),props.hasOwnProperty("accesskey")&&(this.accesskey=props.accesskey),props.hasOwnProperty("max")&&(this.max=props.max),this.prepare_html(),this.register_events(),this.init_recorder(this.audiorecid)},init_strings:function(){for(var that=this,strings=["deletedialogtitle","deletedialogquestion","deletelabel"],i=0;i<strings.length;i++)str.get_string(strings[i],"mod_cpassignment").then((function(stringdata){that.strings[i]=stringdata}))},prepare_html:function(){this.controls.arecstartbutton=$("#"+this.modulecssclass+"_listaudiorecstart"),this.controls.arecstartcontainer=$("."+this.modulecssclass+"_listaudiorecstartcontainer"),this.controls.shareboxbutton=$("#"+this.modulecssclass+"_listshareboxstart"),this.controls.shareboxresetkeybutton=$("#"+this.modulecssclass+"_sharebox_resetkey_button"),this.controls.sharebox=$("#"+this.modulecssclass+"_sharebox"),this.controls.shareboxcopybutton=$("#"+this.modulecssclass+"_sharebox_copy_button"),this.controls.receiptscontainer=$("#"+this.modulecssclass+"_receipts_container"),this.controls.noitemscontainer=$("#"+this.modulecssclass+"_noitems_cont"),this.controls.itemscontainer=$("#"+this.modulecssclass+"_items_cont"),this.controls.areccontainer=$("#"+this.modulecssclass+"_arec_container"),this.controls.rectable=$("#"+this.modulecssclass+"_itemstable__opts_9999"),this.controls.itemnamefield=$(".itemform_itemname"),this.controls.itemidfield=$(".itemform_itemid"),this.controls.itemfilenamefield=$(".itemform_itemfilename"),this.controls.itemsubidfield=$(".itemform_itemsubid"),this.controls.dialogdownloadlink=$("#"+this.modulecssclass+"_download_link"),this.controls.dialogdownloadbutton=$("#"+this.modulecssclass+"_download_button"),this.controls.dialogdownloadname=$("#"+this.modulecssclass+"_download_name"),this.controls.downloadlinkcopybutton=$("#"+this.modulecssclass+"_download_copy_button"),this.audiorecid="therecorderid_mod_cpassignment_listaudiorec",this.controls.deletebutton=$("#"+this.modulecssclass+'_itemstable__opts_9999 a[data-type="delete"]'),this.controls.downloadbutton=$("#"+this.modulecssclass+'_itemstable__opts_9999 a[data-type="download"]'),this.controls.recordingsexceeded=$("#"+this.modulecssclass+"_recordingsexceeded_cont"),this.controls.arecstartbutton.show(),this.controls.shareboxbutton.show(),this.controls.thedatatable=datatables.getDataTable(this.modulecssclass+"_itemstable__opts_9999")},register_events:function(){var that=this;this.controls.arecstartbutton.click((function(){that.controls.itemfilenamefield.val(""),that.controls.itemidfield.val(""),that.controls.itemnamefield.val(""),that.controls.itemsubidfield.val("0"),dialogs.openModal("#"+that.modulecssclass+"_arec_container")})),this.controls.shareboxbutton.click((function(){that.show_sharebox()})),this.controls.shareboxresetkeybutton.click((function(){return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:"Reset the Public Link",body:"Resetting the public link will change it and the previous link will no longer work anymore. Are you sure that you want to do this?"}).then((function(modal){modal.setSaveButtonText("RESET"),modal.getRoot().on(ModalEvents.save,(function(){that.do_resetkey(that,that.moduleid)})),modal.show()})),!1})),this.controls.shareboxcopybutton.click((function(){var copyText=that.controls.sharebox[0];copyText.select(),copyText.setSelectionRange(0,99999),document.execCommand("copy")})),this.controls.downloadlinkcopybutton.click((function(){var copyText=that.controls.dialogdownloadlink[0];copyText.select(),copyText.setSelectionRange(0,99999),document.execCommand("copy")})),this.controls.rectable.on("click",'a[data-type="download"]',(function(e){var elementid=$(e.currentTarget).data("id");return that.show_download(that,elementid),!1})),this.controls.rectable.on("click",'a[data-type="delete"]',(function(e){var clickedLink=$(e.currentTarget),elementid=clickedLink.data("id"),audiotitle=$('td.itemname span[data-itemid="'+elementid+'"]').data("value");return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:"Delete Media",body:"Do you really want to delete audio? <i>"+audiotitle+"</i>"}).then((function(modal){modal.setSaveButtonText("DELETE"),modal.getRoot().on(ModalEvents.save,(function(){that.controls.thedatatable.row(clickedLink.parents("tr")).remove().draw(),that.controls.thedatatable.rows().count()||(that.controls.noitemscontainer.show(),that.controls.itemscontainer.hide()),that.do_delete(elementid),that.check_item_count(that)})),modal.show()})),!1}))},check_item_count:function(that){var itemcount=that.controls.thedatatable.rows().count();that.max>0&&itemcount>=that.max?(that.controls.recordingsexceeded.show(),that.controls.arecstartcontainer.addClass("hide")):(that.controls.recordingsexceeded.hide(),that.controls.arecstartcontainer.removeClass("hide"))},show_download:function(that,elementid){var audiotitle=$('td.itemname span[data-itemid="'+elementid+'"]').data("value"),audiolink=$('td.item audio[data-id="'+elementid+'"]').attr("src");that.controls.dialogdownloadlink.val(audiolink),that.controls.dialogdownloadbutton.attr("href",audiolink),that.controls.dialogdownloadname.html("<h3>Download: "+audiotitle+"</h3>"),dialogs.openModal("#"+that.modulecssclass+"_download_container")},show_sharebox:function(){dialogs.openModal("#"+this.modulecssclass+"_sharebox_container")},do_resetkey:function(that,moduleid){Ajax.call([{methodname:"mod_cpassignment_reset_key",args:{moduleid:moduleid},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success){var accesskey=payloadobject.message;that.controls.sharebox.val(cfg.wwwroot+"/mod/cpassignment/k.php?k="+accesskey)}else payloadobject.message&&log.debug("message: "+payloadobject.message)},fail:notification.exception}])},do_delete:function(itemid){Ajax.call([{methodname:"mod_cpassignment_remove_rec",args:{itemid:itemid},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success);else payloadobject.message&&log.debug("message: "+payloadobject.message)},fail:notification.exception}])},init_recorder:function(recorderid){var that=this;cloudpoodll.init(recorderid,(function(message){switch(console.log(message),message.type){case"recording":break;case"awaitingprocessing":that.status,that.status="posted";break;case"filesubmitted":that.controls.itemfilenamefield.val(message.mediaurl);var filename=that.controls.itemfilenamefield.val(),itemid=that.controls.itemidfield.val(),itemname=that.controls.itemnamefield.val(),subid=that.controls.itemsubidfield.val();that.send_submission(subid,filename,itemid,itemname)}}))},re_init_recorder:function(that,recorderid){var rec_div=$("#"+recorderid);rec_div.empty(),rec_div.attr("data-alreadyparsed","false");cloudpoodll.init(recorderid,!1)},insert_new_item:function(that,item){that.controls.noitemscontainer.hide(),that.controls.itemscontainer.show(),templates.render("mod_cpassignment/itemrow",item).then((function(html,js){that.controls.thedatatable.row.add($(html)[0]).draw()}))},acknowledge_receipt:function(that,item){that.controls.receiptscontainer.show(),templates.render("mod_cpassignment/onereceipt",item).then((function(html,js){that.controls.receiptscontainer.prepend(html)}))},send_submission:function(subid,filename,itemid,itemname){var that=this,args={subid:subid,filename:filename,itemname:itemname,itemid:itemid,cmid:that.cmid};"guest"===this.authmode?args.accesskey=that.accesskey:args.accesskey="none",Ajax.call([{methodname:"mod_cpassignment_submit_rec",args:args,done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success){var item=payloadobject.item;"guest"===that.authmode?that.acknowledge_receipt(that,item):(that.insert_new_item(that,item),that.check_item_count(that)),dialogs.closeModal("#"+that.modulecssclass+"_arec_container"),that.re_init_recorder(that,that.audiorecid)}else payloadobject.message&&log.debug("message: "+payloadobject.message),dialogs.closeModal("#"+that.modulecssclass+"_arec_container"),that.clear_recorder(),that.re_init_recorder(that.audiorecid)},fail:notification.exception}])}}}));

//# sourceMappingURL=listhelper.min.js.map